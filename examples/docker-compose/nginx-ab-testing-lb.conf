# Nginx Load Balancer Configuration for A/B Testing
# Traffic splitting between Variant A and Variant B

events {
    worker_connections 1024;
}

http {
    # Variant A (Control)
    upstream variant_a_backend {
        server app-variant-a:80;
    }

    # Variant B (Test)
    upstream variant_b_backend {
        server app-variant-b:80;
    }

    # Split traffic 50/50 between variants
    # Using consistent hashing based on user identifier
    split_clients "${remote_addr}${http_user_agent}" $variant {
        50% variant_a_backend;  # 50% to Variant A
        50% variant_b_backend; # 50% to Variant B
    }

    server {
        listen 80;
        server_name localhost;

        # Main traffic routing with A/B split
        location / {
            proxy_pass http://$variant;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Variant $variant;
        }

        # Health check endpoint
        location /health {
            # Check both variants
            proxy_pass http://variant_a_backend/health;
            access_log off;
        }

        # Direct access to Variant A
        location /variant-a/ {
            proxy_pass http://variant_a_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Variant "A";
        }

        # Direct access to Variant B
        location /variant-b/ {
            proxy_pass http://variant_b_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Variant "B";
        }

        # Metrics endpoint for Variant A
        location /metrics/a {
            proxy_pass http://variant_a_backend/metrics;
            proxy_set_header Host $host;
            access_log off;
        }

        # Metrics endpoint for Variant B
        location /metrics/b {
            proxy_pass http://variant_b_backend/metrics;
            proxy_set_header Host $host;
            access_log off;
        }

        # A/B Test status
        location /ab-test/status {
            access_log off;
            return 200 "A/B Test Status\nVariant A: 50%\nVariant B: 50%\n";
            add_header Content-Type text/plain;
        }
    }
}

# To adjust traffic split:
# 1. Edit the split_clients percentages above
# 2. Reload nginx: docker exec ab-test-lb nginx -s reload
# 
# Example splits:
# - 70/30: 70% variant_a_backend; 30% variant_b_backend;
# - 80/20: 80% variant_a_backend; 20% variant_b_backend;
# - 90/10: 90% variant_a_backend; 10% variant_b_backend;
# - 100/0: 100% variant_a_backend; (winner determined)

