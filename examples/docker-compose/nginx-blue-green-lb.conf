# Nginx Load Balancer Configuration for Blue-Green Deployment
# Switch between Blue (current) and Green (new) environments

events {
    worker_connections 1024;
}

http {
    # Active environment (switch this to change traffic)
    upstream app_active {
        server app-blue:80;  # Change to app-green:80 to switch
    }

    # Inactive environment (kept running for rollback)
    upstream app_inactive {
        server app-green:80;  # Change to app-blue:80 to switch
    }

    server {
        listen 80;
        server_name localhost;

        # Main traffic goes to active environment
        location / {
            proxy_pass http://app_active;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Environment "active";
        }

        # Health check endpoint
        location /health {
            proxy_pass http://app_active/health;
            access_log off;
        }

        # Test inactive environment
        location /inactive/ {
            proxy_pass http://app_inactive/;
            proxy_set_header Host $host;
            proxy_set_header X-Environment "inactive";
        }

        # Direct access to Blue
        location /blue/ {
            proxy_pass http://app-blue:80/;
            proxy_set_header Host $host;
            proxy_set_header X-Environment "blue";
        }

        # Direct access to Green
        location /green/ {
            proxy_pass http://app-green:80/;
            proxy_set_header Host $host;
            proxy_set_header X-Environment "green";
        }
    }
}

# To switch traffic:
# 1. Edit this file: swap app_active and app_inactive upstreams
# 2. Reload nginx: docker exec <lb-container> nginx -s reload
# 3. Or use: docker-compose exec nginx-lb nginx -s reload

